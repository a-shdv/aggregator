<!doctype html>
<html lang="en">
<div th:insert="~{/partials/head :: head}"></div>
<body>
<div th:insert="~{/partials/navbar :: navbar}"></div>

<div th:if="${isParserAvailable == true}">
    <!--Вакансия-->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <form id="vacancyForm" th:action="@{/}" th:method="post" class="col-lg-4">
                <h2>Вакансия</h2>
                <input id="username" type="hidden" th:value="${#authentication.principal.username}">
                <!--Название вакансии-->
                <div class="form-group">
                    <label for="title">Название вакансии</label>
                    <input id="title" class="form-control" type="text" name="title" placeholder="Программист" required>
                </div>

                <!--Количество вакансий-->
                <!--                <div class="form-group">-->
                <!--                    <label for="amount">Количество вакансий (min=35, max=1000)</label>-->
                <!--                    <input id="amount" class="form-control" type="text" name="amount" min="35" max="1000"-->
                <!--                           placeholder="500"-->
                <!--                           required>-->
                <!--                </div>-->

                <!--Зарплата-->
                <div class="form-group">
                    <label for="salary">Заработная плата (от ...)</label>
                    <input id="salary" class="form-control" type="number" name="salary" min="0" value="0">
                </div>

                <!--Заработная плата указана-->
                <div class="form-group">
                    <div class="form-check">
                        <label class="form-check-label" for="onlyWithSalary"> Заработная плата указана</label>
                        <input id="onlyWithSalary" class="form-check-input" type="checkbox" name="onlyWithSalary">
                        <br><br>
                    </div>
                </div>

                <!--Опыт работы-->
                <div class="form-group">
                    <label class="form-check-label" for="workExperience">Опыт работы</label>
                    <div id="workExperience" class="form-check">
                        <!--Не имеет значения-->
                        <input id="0" class="form-check-input" type="radio" name="experience" value="0" checked>
                        <label class="form-check-label" for="0">Не имеет значения</label>
                        <br>
                        <!--Нет опыта-->
                        <input id="1" class="form-check-input" type="radio" name="experience" value="1">
                        <label class="form-check-label" for="1">Нет опыта</label>
                        <br>
                        <!--От 1 года до 3 лет-->
                        <input id="2" class="form-check-input" type="radio" name="experience" value="2">
                        <label class="form-check-label" for="2">От 1 года до 3 лет</label>
                        <br>
                        <!--От 3 до 6 лет-->
                        <input id="3" class="form-check-input" type="radio" name="experience" value="3">
                        <label class="form-check-label" for="3">От 3 до 6 лет</label>
                        <br>
                        <!--Более 6 лет-->
                        <input id="4" class="form-check-input" type="radio" name="experience" value="4">
                        <label class="form-check-label" for="4">Более 6 лет</label>
                        <br> <br>
                    </div>
                </div>

                <!--Город-->
                <div class="form-group">
                    <label>Город</label>
                    <label>
                        <select required id="cityId" name="cityId">
                            <option value="" disabled>Выберите город</option>
                            <option value="0" selected>Москва</option>
                            <option value="1">Санкт-Петербург</option>
                            <option value="2">Екатеринбург</option>
                            <option value="3">Новосибирск</option>
                            <option value="4">Казань</option>
                            <option value="5">Нижний Новгород</option>
                            <option value="6">Ульяновск</option>
                            <option value="7">Тольятти</option>
                            <option value="8">Астрахань</option>
                            <option value="9">Уфа</option>
                        </select>
                    </label>
                    <br><br>
                </div>

                <div class="form-group">
                    <!--'Можно удаленно'-->
                    <div class="form-check">
                        <label for="isRemoteAvailable" class="form-check-label">Только удаленно</label>
                        <input id="isRemoteAvailable" class="form-check-input" type="checkbox" name="isRemoteAvailable">
                        <br><br>
                    </div>
                </div>

                <!--Отправка формы-->
                <input class="btn btn-md btn-warning" type="submit" value="Найти">
                <br> <br>
            </form>
        </div>
        <div id="progressbar" class="progress">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!--Все вакансии-->
    <div th:if="${vacancies.isEmpty()}" class="row justify-content-center">
        <div class="alert alert-warning col-6 mb-5 mt-5" role="alert">
            Список вакансий пуст!
        </div>
    </div>

    <div class="container mt-5">
        <div th:if="${error}" th:text="${error}" style="color: red"></div>
        <div th:if="${success}" th:text="${success}" style="color: green"></div>
        <div class="row align-items-center vh-100 mt-3">
            <div class="col-12 mx-auto">
                <div class="row">
                    <h2 th:if="${#lists.isEmpty(vacancies)}">Все вакансии</h2>
                    <div th:each="vacancy : ${vacancies}" class="col-lg-3">
                        <div class="card mb-4" style="width: 18rem; height: 25rem;">
                            <!--Заголовок-->
                            <div class="card-header bg-dark text-center" style="height: 3rem;">
                                <div class="row">
                                    <div class="col-10">
                                        <a th:href="${vacancy.source}" style="text-decoration: none; color: white"
                                           target="_blank">
                                            <h5 class="card-title" th:text="${#strings.abbreviate(vacancy.title, 20)}"
                                                style="width: auto"></h5>
                                        </a>
                                    </div>
                                    <div class="col-2">
                                        <form th:action="@{/favourites}" th:method="post" th:object="${favouriteDto}">
                                            <input type="hidden" name="title" th:value="${vacancy.title}">
                                            <input type="hidden" name="date" th:value="${vacancy.date}">
                                            <input type="hidden" name="company" th:value="${vacancy.company}">
                                            <input type="hidden" name="schedule" th:value="${vacancy.schedule}">
                                            <input type="hidden" name="source" th:value="${vacancy.source}">
                                            <input type="hidden" name="logo" th:value="${vacancy.logo}">

                                            <button type="submit" style="background: none; border: none;">
                                                <img id="starImage" src="/images/star-light.png" alt=""
                                                     style="max-width: 100%; max-height: 100%"
                                                     title="Добавить в избранное">
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!--Картинка-->
                            <div class="card-body d-flex justify-content-center align-items-center"
                                 style="height: 12rem; width: inherit;">
                                <img th:if="${vacancy.logo != null}" class="card-img-top" th:src="${vacancy.logo}"
                                     style="max-height: 100%; max-width: 75%;">
                                <img th:if="${vacancy.logo == null}" class="card-img-top"
                                     th:src="@{/images/no-image.png}"
                                     style="max-height: 100%; max-width: 75%;">
                            </div>

                            <!--Описание вакансии-->
                            <div class="card-body" style="height: 9rem">
                                <p class="card-text"
                                   th:text="${#strings.abbreviate(#strings.replace(vacancy.description, 'Описание вакансии О компании и команде ', ''), 70)}">
                                    <!--th:text="${ #strings.abbreviate(vacancy.description, 110)}"--></p>
                            </div>

                            <!-- Подробнее кнопка -->
                            <div class="d-flex justify-content-between p-2">
                                <a th:href="'https://' + ${#strings.arraySplit(vacancy.source, '/')[1]}"
                                   th:text="${#strings.arraySplit(vacancy.source, '/')[1]}" target="_blank"></a>

                                <a th:href="@{/{id}(id=${vacancy.id})}" class="btn btn-warning mb-2"
                                   style="max-width: 10rem;">Подробнее</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--Пагинация-->
            <div>
                <nav>
                    <ul class="pagination justify-content-center mt-5 mb-5">
                        <!--Пред-->
                        <div th:if="${vacancies.hasPrevious()}">
                            <li class="page-item disabled">
                                <form th:action="@{/}" method="get">
                                    <input type="hidden" name="page"
                                           th:value="${vacancies.previousPageable().pageNumber}"/>
                                    <input type="hidden" name="size"
                                           th:value="${vacancies.previousPageable().pageSize}"/>
                                    <input class="page-link" type="submit" value="Пред."/>
                                </form>
                            </li>
                        </div>

                        <!--След-->
                        <div th:if="${vacancies.hasNext()}">
                            <li class="page-item">
                                <form th:action="@{/}" method="get">
                                    <input type="hidden" name="page" th:value="${vacancies.nextPageable().pageNumber}"/>
                                    <input type="hidden" name="size" th:value="${vacancies.nextPageable().pageSize}"/>
                                    <input class="page-link" type="submit" value="След."/>
                                </form>
                            </li>
                        </div>
                    </ul>
                </nav>
            </div>

            <!--Кнопка "Очистить"-->
            <div th:if="${#lists.isEmpty(vacancies)}">
                <form class="mt-5" th:action="@{/clear}" th:method="post">
                    <input class="btn btn-danger btn-md mb-5" type="submit" value="Очистить" onclick="clearVacancies()">
                </form>
            </div>
        </div>
    </div>
</div>

<div style="display: flex; justify-content: center; align-items: center; height: 100vh;"
     th:if="${isParserAvailable == false}">
    <div class="alert alert-danger col-6 mb-5 mt-5" role="alert">
        Извините, в данный момент сервис недоступен!
    </div>
</div>

<script>
    'use strict';
    document.querySelector('#vacancyForm').addEventListener('submit', connect, true)
    document.querySelector('#progressbar').style.display = 'none'

    let stompClient = null;

    function connect() {
        document.querySelector('#progressbar').style.display = 'block'
        let socket = new SockJS('/aggregator');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/progressbar', onMessageReceived);
            let toSend = JSON.stringify({
                username: document.querySelector("#username").value,
                title: document.querySelector("#title").value,
                salary: document.querySelector('#salary').value,
                onlyWithSalary: document.querySelector('#onlyWithSalary').checked,
                experience: parseInt(document.querySelector('input[name="experience"]:checked').value),
                cityId: parseInt(document.querySelector('#cityId').value),
                isRemoteAvailable: document.querySelector('#isRemoteAvailable').checked
            })
            console.log(toSend)
            stompClient.send("/endpoint/receiveMessage", {}, toSend);
        }, function (error) {
            console.error('Error during WebSocket connection: ' + error);
            document.querySelector('#progressbar').style.display = 'none'; // Hide the progress bar on error
        });
        event.preventDefault()
    }

    function onMessageReceived(payload) {
        // Handle received messages
        console.log('Received message: ' + payload.body);
        // Additional message handling if needed
    }

    function clearVacancies() {
        confirm("Вы уверены, что хотите очистить список вакансий?")
    }
</script>
<!--<div th:insert="~{/partials/footer :: footer}"></div>-->
</body>
</html>