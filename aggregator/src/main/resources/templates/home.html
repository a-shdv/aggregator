<!doctype html>
<html lang="en">
<div th:insert="~{/partials/head :: head}"></div>
<body>
<div th:insert="~{/partials/navbar :: navbar}"></div>

<div th:if="${isParserAvailable == true}">
    <!--Вакансия-->
    <div id="vacancy" class="container mt-5">
        <div class="row justify-content-center">
            <form id="vacancyForm" th:action="@{/vacancies}" th:method="post" class="col-lg-4">
                <h2>Вакансия</h2>
                <input id="username" type="hidden" th:value="${#authentication.principal.username}">
                <!--Название вакансии-->
                <div class="form-group">
                    <label for="title">Название вакансии</label>
                    <input id="title" class="form-control" type="text" name="title" placeholder="Программист" required>
                </div>

                <!--Зарплата-->
                <div class="form-group">
                    <label for="salary">Заработная плата (от ...)</label>
                    <input id="salary" class="form-control" type="number" name="salary" min="0" value="0">
                </div>

                <!--Заработная плата указана-->
                <div class="form-group">
                    <div class="form-check">
                        <label class="form-check-label" for="onlyWithSalary"> Заработная плата указана</label>
                        <input id="onlyWithSalary" class="form-check-input" type="checkbox" name="onlyWithSalary">
                        <br><br>
                    </div>
                </div>

                <!--Опыт работы-->
                <div class="form-group">
                    <label class="form-check-label" for="workExperience">Опыт работы</label>
                    <div id="workExperience" class="form-check">
                        <!--Не имеет значения-->
                        <input id="0" class="form-check-input" type="radio" name="experience" value="0" checked>
                        <label class="form-check-label" for="0">Не имеет значения</label>
                        <br>
                        <!--Нет опыта-->
                        <input id="1" class="form-check-input" type="radio" name="experience" value="1">
                        <label class="form-check-label" for="1">Нет опыта</label>
                        <br>
                        <!--От 1 года до 3 лет-->
                        <input id="2" class="form-check-input" type="radio" name="experience" value="2">
                        <label class="form-check-label" for="2">От 1 года до 3 лет</label>
                        <br>
                        <!--От 3 до 6 лет-->
                        <input id="3" class="form-check-input" type="radio" name="experience" value="3">
                        <label class="form-check-label" for="3">От 3 до 6 лет</label>
                        <br>
                        <!--Более 6 лет-->
                        <input id="4" class="form-check-input" type="radio" name="experience" value="4">
                        <label class="form-check-label" for="4">Более 6 лет</label>
                        <br> <br>
                    </div>
                </div>

                <!--Город-->
                <div class="form-group">
                    <label>Город</label>
                    <label>
                        <select required id="cityId" name="cityId">
                            <option value="" disabled>Выберите город</option>
                            <option value="0" selected>Москва</option>
                            <option value="1">Санкт-Петербург</option>
                            <option value="2">Екатеринбург</option>
                            <option value="3">Новосибирск</option>
                            <option value="4">Казань</option>
                            <option value="5">Нижний Новгород</option>
                            <option value="6">Ульяновск</option>
                            <option value="7">Тольятти</option>
                            <option value="8">Астрахань</option>
                            <option value="9">Уфа</option>
                        </select>
                    </label>
                    <br><br>
                </div>

                <div class="form-group">
                    <!--'Можно удаленно'-->
                    <div class="form-check">
                        <label for="isRemoteAvailable" class="form-check-label">Только удаленно</label>
                        <input id="isRemoteAvailable" class="form-check-input" type="checkbox" name="isRemoteAvailable">
                        <br><br>
                    </div>
                </div>

                <!--isConsumingCancelled-->
                <div>
                    <input type="hidden" th:value="false" name="isConsumingCancelled">
                </div>

                <!--Отправка формы-->
                <input class="btn btn-md btn-warning mt-3" type="submit" value="Найти">
            </form>
        </div>
    </div>

    <!--Прогресс бар-->
    <div class="container justify-content-center align-items-center">
        <div id="spaceBefore"></div>
        <div id="progressbar" class="progress" style="display: none;">
            <div id="progressbar-loader" class="progress-bar bg-warning" role="progressbar"
                 aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
        </div>

        <form id="buttonCancelSearch" class="text-center" th:action="@{/stop-consuming-messages}" th:method="post"
              style="display: none">
            <input type="hidden" th:value="true" name="isConsumingCancelled">
            <input class="btn btn-md btn-warning mt-3" type="submit" value="Отменить">
        </form>
        <div style="display: flex; justify-content: center">
            <a id="buttonOk" th:href="@{/vacancies}" style="display: none">
                <button type="button" class="btn btn-md btn-success mt-3">Перейти</button>
            </a>
        </div>

        <div id="spaceAfter"></div>
    </div>


    <!--Пустые вакансии-->
    <!--    <div th:if="${vacancies.isEmpty()}" class="row justify-content-center">-->
    <!--        <div id="emptyVacanciesAlert" class="alert alert-warning col-6 mb-5 mt-5" role="alert">-->
    <!--            Список вакансий пуст!-->
    <!--        </div>-->
    <!--    </div>-->
</div>

<div style="display: flex; justify-content: center; align-items: center; height: 100vh;"
     th:if="${isParserAvailable == false}">
    <div class="alert alert-danger col-6 mb-5 mt-5" role="alert">
        Извините, в данный момент сервис недоступен!
    </div>
</div>

<div th:insert="~{/partials/footer :: footer}"></div>
<script>
    'use strict';
    document.querySelector('#vacancyForm').addEventListener('submit', connect, true)
    // document.querySelector('#progressbar').style.display = 'hidden'

    let stompClient = null;
    let vacancy = document.querySelector('#vacancy')
    let progressBar = document.querySelector('#progressbar')
    let progressBarLoader = document.querySelector('#progressbar-loader')
    let spaceBefore = document.querySelector('#spaceBefore')
    let spaceAfter = document.querySelector('#spaceAfter')
    let buttonCancelSearch = document.querySelector('#buttonCancelSearch')
    let buttonOk = document.querySelector('#buttonOk')

    function connect() {
        event.preventDefault()
        // document.querySelector('#progressbar').style.display = 'block'
        let socket = new SockJS('/aggregator');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame)

            // ON RECEIVE
            stompClient.subscribe('/topic/progressbar', function (response) {
                let message = JSON.parse(response.body);
                progressBarLoader.style.width = message + '%'
                if (parseInt(progressBarLoader.style.width) >= parseInt('100%')) {
                    progressBarLoader.classList.remove('bg-warning')
                    progressBarLoader.classList.add('bg-success')
                    buttonCancelSearch.style.display = 'none'
                    buttonOk.style.display = ''
                    // progressBarLoader.style.width = '100%';
                    // progressBarLoader.setAttribute('aria-valuenow', '25');
                    // progressBarLoader.setAttribute('aria-valuemin', '0');
                    // progressBarLoader.setAttribute('aria-valuemax', '100');
                }
            });

            // BEFORE SEND
            vacancy.style.display = 'none'
            spaceBefore.style.height = '50vh'
            spaceAfter.style.height = '50vh'
            progressBar.style.display = ''
            buttonCancelSearch.style.display = ''
            // document.querySelector('#emptyVacanciesAlert').style.display = ''
            // document.querySelector('#vacanciesList').style.display = ''
            // document.querySelector('#clearButton').style.display = ''

            stompClient.send("/endpoint/toJava", {}, JSON.stringify({
                username: document.querySelector("#username").value,
                title: document.querySelector("#title").value,
                salary: document.querySelector('#salary').value,
                onlyWithSalary: document.querySelector('#onlyWithSalary').checked,
                experience: parseInt(document.querySelector('input[name="experience"]:checked').value),
                cityId: parseInt(document.querySelector('#cityId').value),
                isRemoteAvailable: document.querySelector('#isRemoteAvailable').checked
            }));
        }, function (error) {
            console.error('Error during WebSocket connection: ' + error);
            // document.querySelector('#progressbar').style.display = 'none';
        });
    }

    function clearVacancies() {
        confirm("Вы уверены, что хотите очистить список вакансий?")
    }
</script>
<!--<div th:insert="~{/partials/footer :: footer}"></div>-->
</body>
</html>